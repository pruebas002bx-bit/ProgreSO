{% extends 'base.html' %}

{% block head_extra %}
    <!-- Chart.js (Necesario para el gráfico de radar) -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
{% endblock %}

{% block content %}
<!-- Saludo -->
<h2 class="text-3xl font-semibold text-gray-800 mb-6">¡Bienvenido de nuevo, {{ stats.username }}!</h2>

<!-- Grid de Estadísticas Principales (CORREGIDO) -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
    
    <!-- Nivel -->
    <div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4 border border-gray-200">
        <div class="bg-blue-100 p-3 rounded-full">
            <i class="fa-solid fa-star h-6 w-6 text-blue-600"></i>
        </div>
        <div>
            <p class="text-sm text-gray-600">Nivel</p>
            <p class="text-3xl font-bold text-gray-900">{{ stats.nivel }}</p>
        </div>
    </div>
    
    <!-- Vida (HP) -->
    <div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4 border border-gray-200">
        <div class="bg-green-100 p-3 rounded-full">
            <i class="fa-solid fa-heart h-6 w-6 text-green-600"></i>
        </div>
        <div>
            <p class="text-sm text-gray-600">Vida (HP)</p>
            <p class="text-3xl font-bold text-gray-900">{{ stats.vida }}<span class="text-lg">%</span></p>
        </div>
    </div>

    <!-- Pesos (COP) -->
    <div class="bg-white p-6 rounded-xl shadow-sm flex items-center space-x-4 border border-gray-200">
        <div class="bg-yellow-100 p-3 rounded-full">
            <i class="fa-solid fa-coins h-6 w-6 text-yellow-600"></i>
        </div>
        <div>
            <p class="text-sm text-gray-600">Pesos (COP)</p>
            <!-- CORRECCIÓN: El $ está aquí, y el filtro ya no lo tiene -->
            <p class="text-2xl font-bold text-gray-900">$ {{ stats.pesos | format_pesos }}</p>
        </div>
    </div>

    <!-- XP (Experiencia) (CORREGIDO - Layout) -->
    <div class="bg-white p-6 rounded-xl shadow-sm lg:col-span-3 border border-gray-200">
        <div class="flex justify-between items-center mb-2">
            <p class="text-sm font-medium text-gray-700">Progreso de Experiencia</p>
            <p class="text-sm font-medium text-blue-600">{{ stats.xp_actual }} / {{ stats.xp_siguiente_nivel }} XP</p>
        </div>
        <div class="w-full bg-gray-200 rounded-full h-3">
            <div class="bg-blue-600 h-3 rounded-full transition-all duration-500" style="width: {{ xp_percent }}%;"></div>
        </div>
    </div>
</div>

<!-- Título de Áreas -->
<h2 class="text-2xl font-semibold text-gray-800 mb-6">Resumen de Áreas de Vida</h2>

<!-- Contenedor de Áreas de Vida y Gráfico (NUEVO Layout) -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
    
    <!-- Columna de Áreas (ocupa 2 columnas en large) -->
    <div class="lg:col-span-2 space-y-6">
        {% if areas %}
            {% for area in areas %}
            <!-- Tarjeta de Área Individual -->
            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                <!-- Encabezado del Área -->
                <div class="flex items-center space-x-3 mb-4">
                    <span class="flex items-center justify-center h-10 w-10 rounded-full bg-blue-100 text-blue-600">
                        {% if area.icono_svg == 'icono-salud' %}
                            <i class="fa-solid fa-heart-pulse"></i>
                        {% elif area.icono_svg == 'icono-dinero' %}
                            <i class="fa-solid fa-sack-dollar"></i>
                        {% elif area.icono_svg == 'icono-carrera' %}
                            <i class="fa-solid fa-briefcase"></i>
                        {% elif area.icono_svg == 'icono-estudio' %}
                            <i class="fa-solid fa-book-open"></i>
                        {% elif area.icono_svg == 'icono-mente' %}
                            <i class="fa-solid fa-brain"></i>
                        {% elif area.icono_svg == 'icono-social' %}
                            <i class="fa-solid fa-users"></i>
                        {% elif area.icono_svg == 'icono-hobby' %}
                            <i class="fa-solid fa-guitar"></i>
                        {% else %}
                            <i class="fa-solid fa-star"></i>
                        {% endif %}
                    </span>
                    <h3 class="text-xl font-semibold text-gray-900">{{ area.nombre }}</h3>
                </div>

                <!-- Contenido del Área (Misiones y Hábitos) -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Misiones Activas -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">Misiones Activas</h4>
                        <ul class="space-y-2">
                            {% set misiones_activas = area.misiones | selectattr('completada', 'equalto', false) | list %}
                            {% if misiones_activas %}
                                {% for mision in misiones_activas[:3] %} <!-- Mostrar max 3 -->
                                <li class="text-gray-800 text-sm">
                                    <i class="fa-solid fa-bullseye fa-fw text-gray-400 mr-1"></i>
                                    {{ mision.titulo }}
                                    <!-- Lógica de Plazo -->
                                    {% if mision.plazo %}
                                        {% set hoy = (datetime.utcnow() + timedelta(days=-1)).date() %}
                                        {% set plazo_fecha = mision.plazo.date() %}
                                        <span class="text-xs {% if plazo_fecha < hoy %}text-red-600{% else %}text-gray-500{% endif %}">
                                            (Plazo: {{ mision.plazo.strftime('%d-%m') }})
                                        </span>
                                    {% endif %}
                                </li>
                                {% endfor %}
                            {% else %}
                                <li class="text-gray-500 text-sm italic">Sin misiones activas.</li>
                            {% endif %}
                        </ul>
                        <a href="{{ url_for('misiones') }}" class="text-sm font-medium text-blue-600 hover:underline mt-2 inline-block">Ver todas...</a>
                    </div>
                    <!-- Hábitos Activos -->
                    <div>
                        <h4 class="text-sm font-medium text-gray-500 mb-2">Hábitos Diarios</h4>
                        <ul class="space-y-2">
                            {% if area.habitos %}
                                {% for habito in area.habitos[:3] %} <!-- Mostrar max 3 -->
                                <li class="text-gray-800 text-sm">
                                    <i class="fa-solid fa-calendar-check fa-fw text-gray-400 mr-1"></i>
                                    {{ habito.titulo }} (Racha: {{ habito.racha }})
                                </li>
                                {% endfor %}
                            {% else %}
                                <li class="text-gray-500 text-sm italic">Sin hábitos activos.</li>
                            {% endif %}
                        </ul>
                        <a href="{{ url_for('habitos') }}" class="text-sm font-medium text-blue-600 hover:underline mt-2 inline-block">Ver todos...</a>
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-10 bg-white rounded-xl shadow-sm border border-gray-200">
                <i class="fa-solid fa-layer-group fa-3x text-gray-400"></i>
                <h3 class="mt-4 text-xl font-semibold text-gray-900">Aún no tienes Áreas de Vida</h3>
                <p class="mt-1 text-gray-500">
                    Ve a "Gestionar Áreas" en el menú para crear tu primera área, como "Salud" o "Finanzas".
                </p>
                <a href="{{ url_for('areas') }}" class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white font-medium py-2 px-4 rounded-lg">
                    Crear mi primera Área
                </a>
            </div>
        {% endif %}
    </div>

    <!-- Columna del Gráfico (ocupa 1 columna en large) (NUEVO) -->
    <div class="lg:col-span-1">
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
            <h3 class="text-xl font-semibold mb-4 text-gray-900">Enfoque de Tareas</h3>
            <p class="text-sm text-gray-600 mb-4">
                Distribución de todas tus tareas (misiones y hábitos) por área.
            </p>
            <div class="h-80 w-full">
                <canvas id="radarChart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- =================================== -->
<!-- JavaScript para Gráfico Radar       -->
<!-- =================================== -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('radarChart');
        if (ctx) {
            // Preparamos los datos que vienen desde Flask/Jinja
            const labels = [];
            const dataMisiones = [];
            const dataHabitos = [];

            {% for area in areas %}
                labels.push("{{ area.nombre }}");
                dataMisiones.push({{ area.misiones | selectattr('completada', 'equalto', false) | list | length }});
                dataHabitos.push({{ area.habitos | list | length }});
            {% endfor %}

            new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Misiones Activas',
                            data: dataMisiones,
                            fill: true,
                            backgroundColor: 'rgba(59, 130, 246, 0.2)', // blue-500 con opacidad
                            borderColor: 'rgb(59, 130, 246)',
                            pointBackgroundColor: 'rgb(59, 130, 246)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(59, 130, 246)'
                        },
                        {
                            label: 'Hábitos Activos',
                            data: dataHabitos,
                            fill: true,
                            backgroundColor: 'rgba(22, 163, 74, 0.2)', // green-600 con opacidad
                            borderColor: 'rgb(22, 163, 74)',
                            pointBackgroundColor: 'rgb(22, 163, 74)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgb(22, 163, 74)'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            angleLines: {
                                color: '#e5e7eb' // gray-200
                            },
                            grid: {
                                color: '#e5e7eb' // gray-200
                            },
                            pointLabels: {
                                font: {
                                    size: 14,
                                    family: 'Inter, sans-serif'
                                },
                                color: '#1f2937' // gray-800
                            },
                            ticks: {
                                backdropColor: 'rgba(255, 255, 255, 0.75)',
                                color: '#6b7280', // gray-500
                                stepSize: 1 // Mostrar 1, 2, 3...
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: {
                                    family: 'Inter, sans-serif'
                                }
                            }
                        }
                    }
                }
            });
        }
    });
</script>

{% endblock %}